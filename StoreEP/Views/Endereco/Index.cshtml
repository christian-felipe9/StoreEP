@model IEnumerable<Endereco>
@{
    ViewBag.Title = "Lista de Endereços";
    Layout = "_Layout";
    var enderecoUtilizado = Model.Select(e => e.DataUtilizacao).Max();
}
<style>
    .card {
        box-shadow: 0px 0px 2px #8f8f8f;
        padding: 10px;
        margin: 10px;
    }
</style>
<div class="container">
    @if (TempData["endereco"] != null)
    {
        <div class="alert alert-success">
            <strong>@TempData["endereco"]</strong>
        </div>
    }
    <div class="row">
        @foreach (var endereco in Model)
        {
            <div class="card col col-sm-3"
                 style="@(endereco.DataUtilizacao == enderecoUtilizado ? "box-shadow: 1px 1px 4px #006555, 1px 1px 4px #14673a;" : "box-shadow: 0px 0px 2px #8f8f8f;") ">
                <div class="card-body">
                    <div class="card-header">
                        @endereco.Estado<br>
                    </div>
                    <h5>
                        @endereco.Rua,
                        @endereco.Numero<br>
                        @endereco.Bairro<br>
                        @endereco.Cidade<br>
                        @endereco.CEP<br>
                    </h5>
                </div>
                <div>
                    <a asp-action="Utilizar"
                       asp-controller="Endereco"
                       asp-route-enderecoId="@endereco.EnderecoID"
                       style="right:10px; margin: 4px;"
                       title="Usar este endereço">
                        <span class="glyphicon glyphicon-send"></span>
                    </a>
                    <a asp-action="Apagar"
                       asp-controller="Endereco"
                       asp-route-enderecoId="@endereco.EnderecoID"
                       style="right:10px; margin: 4px;"
                       title="Apagar endereço">
                        <span class="glyphicon glyphicon-trash"></span>
                    </a>
                    <a id="@endereco.EnderecoID"
                       style="right:10px; margin: 4px;"
                       class="editar"
                       title="Editar endereço">
                        <span class="glyphicon glyphicon-edit"></span>
                    </a>
                </div>
            </div>
        }
    </div>
    <div class="text-center">
        <a asp-controller="Endereco" asp-action="Criar" class="btn btn-default btn-xs btn-success">Criar novo</a>
        <a asp-controller="Pedido" asp-action="Finalizar" class="btn btn-default btn-xs btn-primary">Finalizar pedido</a>
    </div>
</div>
<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Endereço</h4>
            </div>
            <div class="modal-body">
                <form method="post">
                    <div class="form-row">
                        <input id="EnderecoID" type="hidden" />
                        <div class="form-group col-md-12">
                            <div class="form-group">
                                <label class="col-form-label">Rua</label>
                                <input id="Rua" type="text" class="form-control">
                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <div class="form-group">
                                <label class="col-form-label">Bairro</label>
                                <input id="Bairro" type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label class="col-form-label">Número</label>
                            <input id="Numero" type="text" class="form-control">
                        </div>
                        <div class="form-group col-md-8">
                            <label class="col-form-label">Complemento</label>
                            <input id="Complemento" class="form-control" type="text">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <label class="col-form-label">Cidade</label>
                            <input id="Cidade" class="form-control" type="text">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <label>Estado</label>
                            <input id="Estado" class="form-control" type="text">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="col-form-label">CEP</label>
                            <input id="CEP" class="form-control" type="text">
                            <button class="btn btn-sm btn-success" type="submit" style="margin:10px 0 10px 0">@(ViewData["editar_endereco"] != null ? "Editar" : "Criar") Endereço</button>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="col-form-label">Pais</label>
                            <input id="Pais" class="form-control" type="text">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script>
        $(".editar").click(function () {
            if ($.active != 0) {
                return;
            }
            var enderecoID = { model: parseInt($(this).prop("id")) };
            console.log($(this).prop("id"));
            $.ajax({
                url: "/Endereco/Editar",
                method: "POST",
                cache: false,
                dataType: "json",
                data: enderecoID,
                success: function (data) {
                    $("#myModal").modal();
                    $("#Rua").val(data.rua);
                    $("#Bairro").val(data.bairro);
                    $("#Cidade").val(data.cidade);
                    $("#Estado").val(data.estado);
                    $("#Numero").val(data.numero);
                    $("#CEP").val(data.cep);
                    $("#Complemento").val(data.complemento);
                },
                error: function (xhr) {
                    tratarExcecao(xhr);
                }
            });
        });
        function limpa_formulário_cep() {
            $("#Rua").val("");
            $("#Bairro").val("");
            $("#Cidade").val("");
            $("#Estado").val("");
        }
        $("#CEP").mask("99999-999");
        $("#CEP").blur(function () {
            var cep = $(this).val().replace(/\D/g, '');
            if (cep != "") {
                var validacep = /^[0-9]{8}$/;
                if (validacep.test(cep)) {
                    $("#Rua").val("...");
                    $("#Bairro").val("...");
                    $("#Cidade").val("...");
                    $("#Estado").val("...");
                    $.getJSON("//viacep.com.br/ws/" + cep + "/json/?callback=?", function (dados) {

                        if (!("erro" in dados)) {
                            $("#Rua").val(dados.logradouro);
                            $("#Bairro").val(dados.bairro);
                            $("#Cidade").val(dados.localidade);
                            $("#Estado").val(dados.uf);
                        }
                        else {
                            limpa_formulário_cep();
                            alert("CEP não encontrado.");
                        }
                    });
                }
                else {
                    limpa_formulário_cep();
                    alert("Formato de CEP inválido.");
                }
            }
            else {
                limpa_formulário_cep();
            }
        });
    </script>
}
